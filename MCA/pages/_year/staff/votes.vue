<template>
    <div class="admin">
        <div class="staff-main">
            <div class="staff-filters">
                <search-bar
                    :placeholder="canSearch ?
                        $t('mca.nom_vote.search') :
                        'searching is disabled'"
                    :disabled="!canSearch"
                    @update:search="text = $event"
                >
                    <button-group
                        :options="viewOptions"
                        :selected-buttons="[viewOption]"
                        @group-clicked="changeView"
                    />
                </search-bar>
            </div>

            <div
                class="scroll__mca"
                :class="`scroll--${viewTheme}`"
            >
                <template
                    v-for="category in relatedCategories"
                >   
                    <StaffAccordianHeader
                        :key="category.id + '-acc-header'"
                        :left="$t(`mca.categories.${category.name}.name`)"
                        :right="category.type"
                        :active="category.id === selectedCategoryId"
                        @on-click="selectCategory(category.id)"
                    />
                    
                    <StaffVoteAccordion
                        v-if="category.id === selectedCategoryId"
                        :key="category.id + '-category'"
                        :view-option="viewOption"
                        :data="selectedCategoryInfo"
                        @remove-vote="removeVote"
                    />
                </template>
            </div>
        </div>
    </div>
</template>

<script lang="ts">
import { Vue, Component } from "vue-property-decorator";
import { namespace, State } from "vuex-class";

import { CategoryInfo } from "../../../../Interfaces/category";
import { ResultVote, StaffVote, UserVote, voteCounter } from "../../../../Interfaces/vote";

import ButtonGroup from "../../../../Assets/components/ButtonGroup.vue";
import SearchBar from "../../../../Assets/components/SearchBar.vue";
import StaffAccordianHeader from "../../../components/staff/StaffAccordionHeader.vue";
import StaffVoteAccordion from "../../../components/staff/StaffVoteAccordion.vue";

const mcaAyimModule = namespace("mca-ayim");
const staffModule = namespace("staff");

interface VotesByCategory {
    category: number;
    userVotes: UserVote[];
}

interface ResultsByCategory {
    category: number;
    results: ResultVote[];
}

type ViewOption = "results" | "voters";

@Component({
    components: {
        ButtonGroup,
        SearchBar,
        StaffAccordianHeader,
        StaffVoteAccordion,
    },
    head () {
        return {
            title: "Votes | Staff | MCA",
        };
    },
})
export default class Votes extends Vue {
    
    @State viewTheme!: "light" | "dark";
    @mcaAyimModule.State selectedMode!: string;
    @staffModule.State categories!: CategoryInfo[];

    votes: StaffVote[] = [];
    viewOptions = ["results", "voters"];
    viewOption: ViewOption = "results";
    text = "";
    selectedCategoryId: null | number = null;

    get relatedCategories (): CategoryInfo[] {
        return this.categories.filter(c => c.mode === this.selectedMode || c.mode === "storyboard");
    }

    get votesByCategory (): VotesByCategory[] {
        let groups: VotesByCategory[] = [];

        for (const vote of this.votes) {
            if (this.text && this.viewOption === "voters") {
                const lowerText = this.text.toLowerCase();
                if (vote.user?.osuID) {
                    if (
                        !vote.voter.osuUsername.toLowerCase().includes(lowerText) &&
                        !vote.voter.osuID.includes(lowerText) &&
                        !vote.voter.discordUsername.includes(lowerText) &&
                        !vote.user.osuUsername.toLowerCase().includes(lowerText) && 
                        !vote.user.osuID.includes(lowerText) &&
                        !vote.user.discordUsername.toLowerCase().includes(lowerText)
                    )
                        continue;
                } else if (vote.beatmapset?.ID) {
                    if (
                        !vote.voter.osuUsername.toLowerCase().includes(lowerText) &&
                        !vote.voter.osuID.includes(lowerText) &&
                        !vote.voter.discordUsername.includes(lowerText) &&
                        !vote.beatmapset.ID.toString().includes(lowerText) &&
                        !vote.beatmapset.artist.toLowerCase().includes(lowerText) &&
                        !vote.beatmapset.title.toLowerCase().includes(lowerText) &&
                        !vote.beatmapset.tags.toLowerCase().includes(lowerText) &&
                        !vote.beatmapset.creator.osuUsername.toLowerCase().includes(lowerText) && 
                        !vote.beatmapset.creator.osuID.includes(lowerText) &&
                        !vote.beatmapset.creator.discordUsername.toLowerCase().includes(lowerText)
                    )
                        continue;
                }
            }

            const resultVote: ResultVote = {
                ...vote,
                inRace: true,
                used: false,
            } as ResultVote;

            const groupIndex = groups.findIndex(g => g.category === vote.category);

            if (groupIndex !== -1) {
                const voterIndex = groups[groupIndex].userVotes.findIndex(v => v.voter?.osuID === vote.voter.osuID);

                if (voterIndex !== -1) {
                    groups[groupIndex].userVotes[voterIndex].votes.push(resultVote);
                } else {
                    groups[groupIndex].userVotes.push({
                        voter: vote.voter,
                        votes: [resultVote],
                    });
                }
            } else {
                groups.push({
                    category: vote.category,
                    userVotes: [{
                        voter: vote.voter,
                        votes: [resultVote],
                    }],
                });
            }
        }

        groups = groups.map(group => {
            group.userVotes = group.userVotes.map(userVote => {
                userVote.votes = userVote.votes.sort((a, b) => a.choice - b.choice);
                return userVote;
            });

            return group;
        });

        return groups;
    }

    get resultsByCategory (): ResultsByCategory[] {
        return this.votesByCategory.map(category => {
            return {
                category: category.category,
                results: voteCounter(category.userVotes, parseInt(this.$route.params.year)),
            };
        });
    }

    get selectedCategoryInfo (): UserVote[] | ResultVote[] {
        if (this.viewOption === "voters") {
            const group = this.votesByCategory.find(group => group.category === this.selectedCategoryId);
            return group?.userVotes ?? [];
        }

        const group = this.resultsByCategory.find(group => group.category === this.selectedCategoryId);
        return group?.results ?? [];
    }

    get canSearch (): boolean {
        return this.viewOption === "voters";
    }

    async selectCategory (id: number | null) {
        if (!id) return;

        if (this.selectedCategoryId === id) {
            this.votes = [];
            this.selectedCategoryId = null;
            return;
        }

        const { data } = await this.$axios.get<{ staffVotes: StaffVote[] }>(`/api/staff/votes?category=${id}`);

        if (!data.success) {
            alert(data.error);
            return;
        }

        this.votes = data.staffVotes;
        this.selectedCategoryId = id;
    }

    async removeVote (id: number, userID: number) {
        if (!confirm("ARE YOU SURE YOU WANT TO DELETE THIS VOTE? IT'S IN CAPS FOR L'EMPHASIS."))
            return;

        try {
            const { data } = await this.$axios.delete(`/api/staff/votes/${id}/${userID}`);

            if (!data.success) {
                alert(data.error);
                return;
            }

            await this.selectCategory(this.selectedCategoryId);
        } catch (e) {
            console.error(e);
            alert("LOOK AT CONSOLE AND ALERT VINXIS IMMEDIATELY!!!!!!!");
        }
    }

    changeView (option: ViewOption) {
        if (option !== this.viewOption) {
            this.votes = [];
            this.selectedCategoryId = null;
        }
        this.viewOption = option;
        this.text = "";
    }
}
</script>

